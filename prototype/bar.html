<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
    <script src="../libs/underscore.js"></script>
    <script src="../libs/jquery.js"></script>
    <script src="../libs/d3.js"></script>

    <!-- src -->
    <script src="../src/class.js"></script>
    <script src="../src/tau.data.js"></script>
    <script src="../src/tau.data.types.js"></script>
    <script src="../src/tau.svg.js"></script>
    <script src="../src/tau.charts.js"></script>
    <script src="../src/charts/line.js"></script>
    <script src="../src/charts/scatterplot.js"></script>
    <script src="../src/charts/bar.js"></script>
    <script src="../src/tau.plugins.js"></script>
    <script src="../src/dsl/units-map.js"></script>
    <script src="../src/dsl/dsl-reader.js"></script>

    <!-- plugins -->
    <script src="../plugins/tooltip.js"></script>
    <script src="../plugins/legend.js"></script>
    <script src="../plugins/highlighter.js"></script>
    <script src="../plugins/projection.js"></script>
    <script src="../plugins/datatable.js"></script>
    <script src="../plugins/header.js"></script>
    <script src="../plugins/trend.js"></script>
    <script src="../plugins/jittering.js"></script>

    <!-- test data -->
    <script src="data.js"></script>

    <script src="countries.js"></script>
    <script src="tpStories.js"></script>
    <style>
        .bar {
            fill: steelblue;
        }
    </style>
    <!-- css -->
    <link href="../css/default.css" rel="stylesheet"/>
    <link href="../css/oldschool.css" rel="stylesheet"/>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,600italic,400,600&subset=latin,cyrillic-ext' rel='stylesheet' type='text/css">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext' rel='stylesheet'
          type='text/css'>
</head>
<body>

<div id="chart-container" style="display:inline-block;margin:0px;border: solid 1px;"></div>

<script>
    function getCountOfEntitiesByTeamOnMonth() {
        var datePrefix = "/Date";
        var dateRegExp = /^\/Date\((-?\d+)(([+-])(\d{2})(\d{2}))\)\//;
        var parseDate = function (dateString) {

            if (_.isString(dateString) && dateString.indexOf(datePrefix) === 0) {

                var res = dateString.match(dateRegExp);
                var serverTime = parseInt(res[1]);
                var serverOffsetMinutes = (parseInt(res[4]) * 60 + parseInt(res[5])) * parseInt(res[3] + '1');

                dateString = new Date(serverTime);
                // dateString.sourceOffset = serverOffsetMinutes;
            }

            return new Date(dateString);
        };
        var host = "https://plan.tpondemand.com";
        var url = host + "/api/v2/UserStory?where=(endDate!=null and (team.name == \"alaska\" or team.name == \"CAT\" or team.name == \"λ\" or team.name == \"NEW TEAM\"))&select={endDate,team:team.name}&take=10000";
        return $
                .ajax({
                    url: url,
                    data: {
                        format: 'json',
                        take: 1000
                    },
                    jsonp: "callback",
                    dataType: "jsonp"
                })
                .then(function (data) {
                    return _(data.items)
                            .chain()
                            .filter(function (x) {
                                return new Date('2013-09-31').getTime() < parseDate(x.endDate);
                            })
                            .map(function (x) {
                                return {
                                    team: x.team || null,
                                    endDate: parseDate(x.endDate)
                                };
                            })
                            .value();
                }).then(function (items) {
                    var byTeams = _.groupBy(items, 'team');

                    var getMonth = function (x) {
                        var sd = x.endDate;
                        var dd = Date.UTC(sd.getUTCFullYear(), sd.getUTCMonth(), 1);
                        return dd;
                    };

                    var zzz = _.reduce(
                            byTeams,
                            function (memo, v, k) {
                                var teams = ['NEW TEAM', 'Alaska', 'NEW TEAM', 'CAT', 'λ'];
                                if (!_.contains(teams, k)) {
                                    return memo
                                }
                                memo[k] = _(v)
                                        .chain()
                                        .groupBy(getMonth)
                                        .reduce(function (res, value, key) {
                                            res.push({x: parseInt(key, 10), y: value.length});
                                            return res;
                                        }, [])
                                        .value();
                                return memo;
                            },
                            {});
                    return zzz;
                }).then(function (data) {
                    return _.flatten(_.map(data, function (values, key) {
                        return _.map(values, function (element) {
                            return {
                                team: key,
                                count: element.y,
                                month: element.x
                            }
                        })
                    })).sort(function (a, b) {
                        return a.month - b.month;
                    }).map(function (e) {
                        var date = new Date(e.month);
                        var s = date.getUTCFullYear() + ' - ' + (date.getUTCMonth()+1);
                        return {
                            team: e.team,
                            count: e.count,
                            month: s
                        }
                    })
                })
    }

    var TEST_DATA = _(getUserStories()).map(function (r, i) {
        r.cycleTime = r.name.length;
        return r;
    });
    var translate = function (left, top) {
        return 'translate(' + left + ',' + top + ')';
    };

    var getDomain = function (data, scaleDim, scaleType) {
        var domain = _(data).chain().pluck(scaleDim);
        return ((scaleType === 'ordinal')
                ? domain.uniq().value()
                : d3.extent(domain.value()));
    };

    var getRangeMethod = function (scaleType) {
        return ((scaleType === 'ordinal')
                ? 'rangeRoundBands'
                : 'rangeRound');
    };

    var metaFilter = function (filterPredicates, row) {
        return _.every(
                filterPredicates,
                function (fnPredicate) {
                    return fnPredicate(row);
                });
    };

    var createEqualPredicate = function (propName, shouldEqualTo) {
        return function (row) {
            return row[propName] === shouldEqualTo;
        };
    };

    var CROSS = function (dimX, dimY) {

        var domains = {
            x: _(TEST_DATA).chain().pluck(dimX).uniq().value(),
            y: _(TEST_DATA).chain().pluck(dimY).uniq().value()
        };

        return _(domains.y).map(function (RV) {
            return _(domains.x).map(function (RC) {
                return metaFilter.bind(
                        null,
                        [
                            createEqualPredicate(dimX, RC),
                            createEqualPredicate(dimY, RV)
                        ]);
            });
        });
    };
    getCountOfEntitiesByTeamOnMonth().then(function (data) {
        TEST_DATA = data;
        var def = {

            dimensions: {
                GDP: 'Gdp',
                HPNS: 'Happiness',
                CNTRY: 'Country'
            },
            unit: {
                type: 'COORDS/RECT',
                func: CROSS,
                axes: [
                    null,//{ scaleDim: 'project', scaleType: 'ordinal', label: '<h4>Projects</h4>' },
                    {scaleDim: 'team', scaleType: 'ordinal', label: '<h4>Teams</h4>', rotate: 45}
                ],
                unit: [
                    {
                        type: 'COORDS/RECT',
                        axes: [
                            {scaleDim: 'month', scaleType: 'ordinal', label: '<h4>effort</h4>'},
                            {scaleDim: 'count', scaleType: 'linear', label: '<h4>cycle time</h4>'},
                        ],
                        unit: [
                            {
                                type: 'ELEMENT/INTERVAL',
                                x: 'month',
                                y: 'count',
                                color: null,
                                size: null,
                                shape: null
                            }
                        ]
                    }
                ]
            }
        };


        // RECT(DIM(GDP, HPNS), POINT({ x: GPR, y: HPNS, color: CNTRY }))
        var reader = new DSLReader(def);
        reader.process(window.countries);
    });

</script>
</body>
</html>