<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
    <script src="../libs/underscore.js"></script>
    <script src="../libs/jquery-2.1.1.min.js"></script>
    <script src="../libs/d3.js"></script>

    <!-- src -->
    <script src="../src/class.js"></script>
    <script src="../src/tau.data.js"></script>
    <script src="../src/tau.data.types.js"></script>
    <script src="../src/tau.svg.js"></script>
    <script src="../src/tau.charts.js"></script>
    <script src="../src/charts/line.js"></script>
    <script src="../src/charts/scatterplot.js"></script>
    <script src="../src/charts/bar.js"></script>
    <script src="../src/tau.plugins.js"></script>

    <!-- plugins -->
    <script src="../plugins/tooltip.js"></script>
    <script src="../plugins/legend.js"></script>
    <script src="../plugins/highlighter.js"></script>
    <script src="../plugins/projection.js"></script>
    <script src="../plugins/datatable.js"></script>
    <script src="../plugins/header.js"></script>
    <script src="../plugins/trend.js"></script>
    <script src="../plugins/jittering.js"></script>

    <!-- test data -->
    <script src="data.js"></script>

    <script src="countries.js"></script>
    <script src="tpStories.js"></script>

    <!-- css -->
    <link href="../css/default.css" rel="stylesheet"/>
    <link href="../css/oldschool.css" rel="stylesheet"/>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,600italic,400,600&subset=latin,cyrillic-ext' rel='stylesheet' type='text/css">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext' rel='stylesheet'
          type='text/css'>
</head>
<body>

<div id="chart-container" style="display:inline-block;margin:0px;border: solid 1px;"></div>

<script>

var TEST_DATA = _(getUserStories()).map(function (r, i) {
    r.cycleTime = r.name.length;
    return r;
});

var translate = function (left, top) {
    return 'translate(' + left + ',' + top + ')';
};

var getDomain = function (data, scaleDim, scaleType) {
    var domain = _(data).chain().pluck(scaleDim);
    return ((scaleType === 'ordinal')
            ? domain.uniq().value()
            : d3.extent(domain.value()));
};

var getRangeMethod = function (scaleType) {
    return ((scaleType === 'ordinal')
            ? 'rangeRoundBands'
            : 'rangeRound');
};

var metaFilter = function (filterPredicates, row) {
    return _.every(
            filterPredicates,
            function (fnPredicate) {
                return fnPredicate(row);
            });
};

var createEqualPredicate = function (propName, shouldEqualTo) {
    return function (row) {
        return row[propName] === shouldEqualTo;
    };
};

var CROSS = function (dimX, dimY) {

    var domains = {
        x: _(TEST_DATA).chain().pluck(dimX).uniq().value(),
        y: _(TEST_DATA).chain().pluck(dimY).uniq().value()
    };

    return _(domains.y).map(function (RV) {
        return _(domains.x).map(function (RC) {
            return metaFilter.bind(
                    null,
                    [
                        createEqualPredicate(dimX, RC),
                        createEqualPredicate(dimY, RV)
                    ]);
        });
    });
};

var UNITS_MAP = {

    'COORDS/RECT': function (unit, unitIterator) {
        var options = unit.options || {};
        var axes = unit.axes;
        var x = _.defaults(axes[0] || {}, { scaleOrient: 'bottom' });
        var y = _.defaults(axes[1] || {}, { scaleOrient: 'left' });
        var PX = 36;
        var PY = 18;

        var W = options.width - 2 * PX;
        var H = options.height - 2 * PY;

        options.container
                .append('rect')
                .attr("width", options.width)
                .attr("height", options.height)
                .style('fill', '#fff')
                .style('fill-opacity', '0.7')
                .style('stroke', '#aaa')
                .attr('transform', translate(options.left, options.top));


        this.container = options
                .container
                .append('g')
                .attr('class', 'cell')
                .attr('transform', translate(options.left + PX, options.top + PY / 2));

        if (x.scaleDim) {
            var xScale = d3
                    .scale[x.scaleType]()
                    .domain(getDomain(TEST_DATA, x.scaleDim, x.scaleType))[getRangeMethod(x.scaleType)]([0, W]);
            var xAxis = d3.svg.axis().scale(xScale).orient(x.scaleOrient);
            this.container
                    .append('g')
                    .attr('class', 'x axis')
                    .attr('transform', translate(0, H))
                    .call(xAxis);
        }

        if (y.scaleDim) {
            var yScale = d3
                    .scale[y.scaleType]()
                    .domain(getDomain(TEST_DATA, y.scaleDim, y.scaleType))[getRangeMethod(y.scaleType)]([H, 0]);
            var yAxis = d3.svg.axis().scale(yScale).orient(y.scaleOrient);
            this.container
                    .append('g')
                    .attr('class', 'y axis')
                    .attr('transform', translate(0, 0))
                    .call(yAxis).selectAll('.tick text').attr('transform', 'rotate(' + (y.rotate || 0) + ')');
        }

        var grid = this.container
                .append('g')
                .attr('class', 'grid')
                .attr('transform', translate(0, 0));

        grid
                .append('rect')
                .attr('class', 'grid')
                .attr('transform', translate(0, 0))
                .style('fill', 'green')
                .style('opacity', '0.2')
                .attr("width", W)
                .attr("height", H);

        var unitFilter = (unit.filter || _.identity);

        var unitOperation = (unit.func || function () {
            return [
                [
                    function (rec) {
                        return unitFilter(rec);
                    }
                ]
            ];
        });

        var matrix2DPredicates = unitOperation(x.scaleDim, y.scaleDim);

        var nR = matrix2DPredicates.length;
        _.each(matrix2DPredicates, function (rowOfPredicates, iRow) {

            var nC = rowOfPredicates.length;
            var cellW = W / nC;
            var cellH = H / nR;

            _.each(rowOfPredicates, function (predicateRC, iCol) {

                unit.unit.forEach(function (node) {
                    node.filter = predicateRC;
                    unitIterator(
                            node,
                            {
                                container: grid,
                                width: cellW,
                                height: cellH,
                                top: iRow * cellH,
                                left: iCol * cellW,
                                xScale: xScale,
                                yScale: yScale
                            });
                });
            })
        });
    },

    'ELEMENT/POINT': function (unit) {
        var options = unit.options || {};

        var update = function () {
            return this
                    .attr('r', 3)
                    .attr('cx', function (d) {
                        return options.xScale(d[unit.x]);
                    })
                    .attr('cy', function (d) {
                        return options.yScale(d[unit.y]);
                    });
        };

        var data = _(TEST_DATA).filter(unit.filter);

        var elements = options.container.selectAll('.dot').data(data);
        elements.call(update);
        elements.enter().append('circle').call(update);
        elements.exit().remove();
    }
};

var def = {

    dimensions: {
        GDP: 'Gdp',
        HPNS: 'Happiness',
        CNTRY: 'Country'
    },
    unit: {
        type: 'COORDS/RECT',
        func: CROSS,
        axes: [
            { scaleDim: 'project', scaleType: 'ordinal', label: '<h4>Projects</h4>' },
            { scaleDim: 'team', scaleType: 'ordinal', label: '<h4>Teams</h4>', rotate: 45 }
        ],
        unit: [
            {
                type: 'COORDS/RECT',
                axes: [
                    { scaleDim: 'cycleTime', scaleType: 'linear', label: '<h4>cycle time</h4>'},
                    { scaleDim: 'effort', scaleType: 'linear', label: '<h4>effort</h4>' }
                ],
                unit: [
                    {
                        type: 'ELEMENT/POINT',
                        x: 'cycleTime',
                        y: 'effort',
                        color: null,
                        size: null,
                        shape: null
                    }
                ]
            }
        ]
    }
};

var DSLReader = function (ast) {

    this.W = 1600;
    this.H = 1000;

    $("#chart-container").css({
        width: this.W,
        height: this.H
    });

    this.container = d3
            .select("#chart-container")
            .append("svg")
            .attr("width", this.W)
            .attr("height", this.H);

    this.ast = ast;
};

DSLReader.prototype = {

    process: function (rawData) {

        var unit = this.ast.unit;

        var unitIterator = function (sUnit, options) {
            sUnit.options = options;
            sUnit.data = (sUnit.filter) ? sUnit.filter(rawData) : rawData;
            UNITS_MAP[sUnit.type](sUnit, unitIterator);
        };

        unitIterator(
                unit,
                {
                    container: this.container,
                    width: this.W,
                    height: this.H,
                    top: 0,
                    left: 0
                });
    }
};

// RECT(DIM(GDP, HPNS), POINT({ x: GPR, y: HPNS, color: CNTRY }))
var reader = new DSLReader(def);
reader.process(window.countries);

</script>
</body>
</html>